name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      rollback:
        description: 'Rollback to previous deploy'
        required: false
        default: false
        type: boolean

jobs:
  # Ensure all tests pass before deploying
  tests:
    name: Run Full Test Suite
    if: ${{ !inputs.rollback }}
    uses: ./.github/workflows/test.yml

  security:
    name: Security Checks
    if: ${{ !inputs.rollback }}
    uses: ./.github/workflows/security.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [tests, security]
    if: github.ref == 'refs/heads/main' && !inputs.rollback

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Notify deployment start
      run: |
        echo "Deploying RivaFlow to production..."
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"

    - name: Trigger Render deployment
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
          echo "ERROR: RENDER_API_KEY or RENDER_SERVICE_ID not configured."
          echo "Configure these secrets to enable CI-triggered deploys."
          exit 1
        else
          echo "Triggering Render deployment for commit ${{ github.sha }}..."
          curl -s -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys"
          echo "API deploy triggered via Render API."
        fi
        echo "Monitor: https://dashboard.render.com/"

    - name: Trigger frontend deployment
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_FRONTEND_SERVICE_ID: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
      run: |
        if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_FRONTEND_SERVICE_ID" ]; then
          echo "RENDER_FRONTEND_SERVICE_ID not configured — skipping frontend deploy."
        else
          echo "Triggering Render frontend deployment..."
          curl -s -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_FRONTEND_SERVICE_ID/deploys"
          echo "Frontend deploy triggered."
        fi

    - name: Wait for deployment health check
      run: |
        echo "Polling health endpoint (max 120s)..."
        for i in $(seq 1 24); do
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.rivaflow.app/health || true)
          if [ "$response" -eq 200 ]; then
            echo "Health check passed after $((i * 5))s"
            break
          fi
          echo "Attempt $i: HTTP $response — retrying in 5s..."
          sleep 5
        done
        if [ "$response" -ne 200 ]; then
          echo "Health check failed after 120s (last HTTP $response)"
          exit 1
        fi

    - name: Verify health endpoint
      id: health_check
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.rivaflow.app/health)
        if [ "$response" -eq 200 ]; then
          echo "Health check passed (HTTP 200)"
          curl -s https://api.rivaflow.app/health | jq '.'
        else
          echo "Health check failed (HTTP $response)"
          exit 1
        fi

    - name: Run smoke tests
      run: |
        echo "Running post-deployment smoke tests..."

        # Test health endpoint (includes database connectivity check)
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.rivaflow.app/health)
        if [ "$response" -eq 200 ]; then
          echo "✓ Health check passed (includes DB connectivity)"
        else
          echo "✗ Health check failed (HTTP $response)"
          exit 1
        fi

        # Test auth endpoint reachable (should return 422 without body, not 500)
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST https://api.rivaflow.app/api/v1/auth/login)
        if [ "$response" -eq 422 ]; then
          echo "✓ Auth endpoint reachable (422 = validation error, expected)"
        else
          echo "✗ Auth endpoint unexpected status (HTTP $response)"
          exit 1
        fi

        # Test frontend is accessible
        response=$(curl -s -o /dev/null -w "%{http_code}" https://rivaflow.app)
        if [ "$response" -eq 200 ] || [ "$response" -eq 301 ] || [ "$response" -eq 302 ]; then
          echo "✓ Frontend accessible (HTTP $response)"
        else
          echo "⚠ Frontend returned HTTP $response (may still be deploying)"
        fi

        echo "All smoke tests passed."

    - name: Notify deployment success
      if: success()
      run: |
        echo "Deployment successful!"
        echo "API: https://api.rivaflow.app"
        echo "Frontend: https://rivaflow.app"
        echo "Docs: https://api.rivaflow.app/docs"

    - name: Notify deployment failure
      if: failure()
      run: |
        echo "Deployment failed!"
        echo "Check Render logs: https://dashboard.render.com/"
        echo "Run manual rollback: gh workflow run deploy.yml -f rollback=true"

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: inputs.rollback
    steps:
    - name: Rollback via Render API
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
          echo "RENDER_API_KEY or RENDER_SERVICE_ID not configured."
          echo "Manual rollback: Go to https://dashboard.render.com/ and select a previous deploy."
          exit 1
        fi

        echo "Fetching recent deploys..."
        deploys=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys?limit=5")

        # Get the second deploy (previous successful one)
        previous_deploy_id=$(echo "$deploys" | jq -r '.[1].deploy.id // empty')

        if [ -z "$previous_deploy_id" ]; then
          echo "No previous deploy found to rollback to."
          exit 1
        fi

        echo "Rolling back to deploy: $previous_deploy_id"
        curl -s -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$previous_deploy_id/rollback"

        echo "Rollback triggered. Waiting 60 seconds..."
        sleep 60

        # Verify health after rollback
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.rivaflow.app/health)
        if [ "$response" -eq 200 ]; then
          echo "Rollback health check passed (HTTP 200)"
        else
          echo "Rollback health check failed (HTTP $response)"
          echo "Manual intervention required."
          exit 1
        fi
