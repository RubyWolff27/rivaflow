name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      rollback:
        description: 'Rollback to previous deploy'
        required: false
        default: false
        type: boolean

jobs:
  # Ensure all tests pass before deploying
  tests:
    name: Run Full Test Suite
    if: ${{ !inputs.rollback }}
    uses: ./.github/workflows/test.yml

  security:
    name: Security Checks
    if: ${{ !inputs.rollback }}
    uses: ./.github/workflows/security.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [tests, security]
    if: github.ref == 'refs/heads/main' && !inputs.rollback

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Notify deployment start
      run: |
        echo "Deploying RivaFlow to production..."
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"

    - name: Trigger Render deployment
      run: |
        # Render auto-deploys on git push to main
        # This step can be enhanced with Render API for controlled deploys
        echo "Render will auto-deploy from main branch"
        echo "Monitor: https://dashboard.render.com/"

    - name: Wait for deployment health check
      run: |
        echo "Waiting 60 seconds for deployment..."
        sleep 60

    - name: Verify health endpoint
      id: health_check
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.rivaflow.app/health)
        if [ "$response" -eq 200 ]; then
          echo "Health check passed (HTTP 200)"
          curl -s https://api.rivaflow.app/health | jq '.'
        else
          echo "Health check failed (HTTP $response)"
          exit 1
        fi

    - name: Run smoke tests
      run: |
        echo "Running post-deployment smoke tests..."

        # Test database health endpoint
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.rivaflow.app/api/v1/health/db)
        if [ "$response" -eq 200 ]; then
          echo "Database health check passed"
        else
          echo "Database health check failed (HTTP $response)"
        fi

    - name: Notify deployment success
      if: success()
      run: |
        echo "Deployment successful!"
        echo "API: https://api.rivaflow.app"
        echo "Frontend: https://rivaflow.app"
        echo "Docs: https://api.rivaflow.app/docs"

    - name: Notify deployment failure
      if: failure()
      run: |
        echo "Deployment failed!"
        echo "Check Render logs: https://dashboard.render.com/"
        echo "Run manual rollback: gh workflow run deploy.yml -f rollback=true"

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: inputs.rollback
    steps:
    - name: Rollback via Render API
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
          echo "RENDER_API_KEY or RENDER_SERVICE_ID not configured."
          echo "Manual rollback: Go to https://dashboard.render.com/ and select a previous deploy."
          exit 1
        fi

        echo "Fetching recent deploys..."
        deploys=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys?limit=5")

        # Get the second deploy (previous successful one)
        previous_deploy_id=$(echo "$deploys" | jq -r '.[1].deploy.id // empty')

        if [ -z "$previous_deploy_id" ]; then
          echo "No previous deploy found to rollback to."
          exit 1
        fi

        echo "Rolling back to deploy: $previous_deploy_id"
        curl -s -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$previous_deploy_id/rollback"

        echo "Rollback triggered. Waiting 60 seconds..."
        sleep 60

        # Verify health after rollback
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.rivaflow.app/health)
        if [ "$response" -eq 200 ]; then
          echo "Rollback health check passed (HTTP 200)"
        else
          echo "Rollback health check failed (HTTP $response)"
          echo "Manual intervention required."
          exit 1
        fi
